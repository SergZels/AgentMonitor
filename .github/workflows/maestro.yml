name: ðŸš€ Deploy to Server Maestro

on:
  push:
    branches: [ Maestro ]
  workflow_dispatch:  # ÐœÐ¾Ð¶Ð»Ð¸Ð²Ñ–ÑÑ‚ÑŒ Ð·Ð°Ð¿ÑƒÑÐºÑƒ Ð²Ñ€ÑƒÑ‡Ð½Ñƒ

env:
  DEPLOY_PATH: "/home/TMP2"  # Ð—Ð¼Ñ–Ð½Ñ–Ñ‚ÑŒ Ð½Ð° Ð²Ð°Ñˆ ÑˆÐ»ÑÑ…

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“‚ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ÐŸÐ¾Ð²Ð½Ð° Ñ–ÑÑ‚Ð¾Ñ€Ñ–Ñ Ð´Ð»Ñ git pull

    - name: ðŸ” Setup SSH Key
      run: |
        # Ð¡Ñ‚Ð²Ð¾Ñ€Ð¸Ñ‚Ð¸ SSH Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ñ–ÑŽ
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # Ð—Ð±ÐµÑ€ÐµÐ³Ñ‚Ð¸ Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ð¸Ð¹ ÐºÐ»ÑŽÑ‡
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        # ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ð¸Ñ‚Ð¸ ÐºÐ»ÑŽÑ‡
        echo "=== SSH Key Validation ==="
        ssh-keygen -y -f ~/.ssh/deploy_key > /dev/null && echo "âœ… Key is valid" || echo "âŒ Key is invalid"
        
        # Ð”Ð¾Ð´Ð°Ñ‚Ð¸ ÑÐµÑ€Ð²ÐµÑ€ Ð´Ð¾ known_hosts
        ssh-keyscan -p ${{ secrets.SSH_PORT || '22' }} -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
        
        echo "âœ… SSH setup completed"

    - name: ðŸ§ª Test SSH Connection
      run: |
        echo "=== Testing SSH Connection ==="
        ssh -i ~/.ssh/deploy_key \
            -p ${{ secrets.SSH_PORT || '22' }} \
            -o ConnectTimeout=10 \
            -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            'echo "âœ… SSH connection successful!" && whoami && pwd'

    - name: ðŸš€ Deploy to Server
      run: |
        echo "=== Starting Deployment ==="
        ssh -i ~/.ssh/deploy_key \
            -p ${{ secrets.SSH_PORT || '22' }} \
            -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
        
        set -e  # Ð—ÑƒÐ¿Ð¸Ð½Ð¸Ñ‚Ð¸ Ð¿Ñ€Ð¸ Ð¿Ð¾Ð¼Ð¸Ð»Ñ†Ñ–
        
        echo "ðŸ“ Navigating to project directory..."
        cd ${{ env.DEPLOY_PATH }}
        
        echo "ðŸ“¥ Pulling latest changes..."
        git pull origin main
        
        echo "ðŸ” Checking for deploy script..."
        if [ -f "deploy.sh" ]; then
            echo "ðŸš€ Running deploy script..."
            chmod +x deploy.sh
            ./deploy.sh
        else
            echo "âš ï¸ deploy.sh not found, performing basic deployment..."
            
            # Ð‘Ð°Ð·Ð¾Ð²Ðµ Ñ€Ð¾Ð·Ð³Ð¾Ñ€Ñ‚Ð°Ð½Ð½Ñ (Ð·Ð¼Ñ–Ð½Ñ–Ñ‚ÑŒ Ð¿Ñ–Ð´ Ð²Ð°ÑˆÑ– Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸)
            if [ -f "requirements.txt" ]; then
                echo "ðŸ“¦ Installing Python dependencies..."
                pip install -r requirements.txt
            fi
            
            if [ -f "package.json" ]; then
                echo "ðŸ“¦ Installing Node.js dependencies..."
                npm install
                npm run build || echo "No build script found"
            fi
        fi
        
        echo "âœ… Deployment completed successfully!"
        EOF

    - name: ðŸ“Š Deployment Summary
      if: always()
      run: |
        echo "=== Deployment Summary ==="
        echo "ðŸ• Time: $(date)"
        echo "ðŸ‘¤ User: ${{ github.actor }}"
        echo "ðŸ“ Commit: ${{ github.sha }}"
        echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"
        
        if [ $? -eq 0 ]; then
            echo "âœ… Status: SUCCESS"
        else
            echo "âŒ Status: FAILED"
        fi